@page
@model WorkingSpaces.Pages.BookingModel
@{
    ViewData["Title"] = "Book a Space";
}

<style>
    .modal {
        display: none; 
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%; 
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>

<h1>Book a Desk</h1>

@if (!string.IsNullOrEmpty(Model.BookingMessage))
{
    <div style="padding: 10px; border: 1px solid @(Model.BookingMessage.StartsWith("Success") ? "green" : "red"); color: @(Model.BookingMessage.StartsWith("Success") ? "green" : "red"); margin-bottom: 15px;">
        <strong>@Model.BookingMessage</strong>
    </div>
}
<hr />

<form method="post">
    <label>Select a date:</label>
    <input type="date" asp-for="SelectedDate" required value="@(Model.SelectedDate?.ToString("yyyy-MM-dd"))" />
    <button type="submit">Check Availability</button>
    <span asp-validation-for="SelectedDate" class="text-danger"></span>
</form>

@if (Model.AvailableSpaces != null && Model.AvailableSpaces.Any())
{
    <hr />
    <h2>Available Rooms on @Model.SelectedDate!.Value.ToString("dd.MM.yyyy")</h2>
    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th>Room ID</th>
                <th>Seats</th>
                <th>Equipment</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var space in Model.AvailableSpaces)
            {
                <tr>
                    <td>@space.RoomId</td>
                    <td>@space.NumberOfSeats</td>
                    <td>@space.AvailableEquipment</td>
                    <td>
                        <button type="button" class="book-btn" data-roomid="@space.RoomId">Book</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else if (Model.SelectedDate.HasValue)
{
    <p>No rooms available for @Model.SelectedDate.Value.ToShortDateString()</p>
}

<div id="bookingModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Book Room <span id="room-id-display"></span></h2>
        
        <form method="post" asp-page-handler="Book">
            <input type="hidden" name="SpaceId" id="modalSpaceId" value="" />
            <input type="hidden" name="SelectedDate" value="@(Model.SelectedDate?.ToString("yyyy-MM-dd"))" />

            <div>
                <label for="StartTime">Start Time (08:00 - 23:00):</label>
                <input type="time" id="StartTime" name="StartTime" value="@(Model.StartTime?.ToString("hh\\:mm"))" min="08:00" max="22:45" required />
                <span asp-validation-for="StartTime" class="text-danger"></span>
            </div>
            <br />
            <div>
                <label for="EndTime">End Time (08:00 - 23:00):</label>
                <input type="time" id="EndTime" name="EndTime" value="@(Model.EndTime?.ToString("hh\\:mm"))" min="08:15" max="23:00" required />
                <span asp-validation-for="EndTime" class="text-danger"></span>
            </div>
            <br />

            <div>
                <label for="UserEmail">Your Email:</label>
                <input type="email" id="UserEmail" name="UserEmail" value="@Model.UserEmail" required />
                <span asp-validation-for="UserEmail" class="text-danger"></span>
            </div>
            <br />
            <button type="submit">Confirm Booking</button>
        </form>
    </div>
</div>

<hr />

<h2>Current Bookings</h2>

@if (Model.CurrentBookings != null && Model.CurrentBookings.Any())
{
    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th>Room ID</th>
                <th>User Email</th>
                <th>Date</th>
                <th>Start Time</th>
                <th>End Time</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var booking in Model.CurrentBookings)
            {
                <tr>
                    <td>@booking.Space.RoomId</td>
                    <td>@booking.UserEmail</td>
                    <td>@booking.StartTime.ToLocalTime().ToString("dd.MM.yyyy")</td>
                    <td>@booking.StartTime.ToLocalTime().ToString("HH:mm")</td>
                    <td>@booking.EndTime.ToLocalTime().ToString("HH:mm")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No bookings have been made yet.</p>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = document.getElementById("bookingModal");
            var span = document.getElementsByClassName("close")[0];
            var spaceIdInput = document.getElementById("modalSpaceId");
            var roomIdDisplay = document.getElementById("room-id-display");

            document.querySelectorAll('.book-btn').forEach(button => {
                button.onclick = function() {
                    var roomId = this.getAttribute('data-roomid');
                    spaceIdInput.value = roomId; 
                    roomIdDisplay.textContent = roomId; 
                    modal.style.display = "block";
                }
            });

            span.onclick = function() {
                modal.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        });
    </script>
}
